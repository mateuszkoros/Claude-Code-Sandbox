# Squid configuration for Claude Code isolation
# Allows internet access, blocks local networks

# Disable ICMP pinger (not needed for HTTP/HTTPS proxy)
pinger_enable off

# Recommended minimum configuration:
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 1025-65535  # unregistered ports

acl CONNECT method CONNECT

# Deny requests to localhost and RFC1918 private addresses
acl localhost src 127.0.0.0/8
acl to_localhost dst 127.0.0.0/8

# Private network ranges to BLOCK
acl private_nets dst 10.0.0.0/8
acl private_nets dst 172.16.0.0/12
acl private_nets dst 192.168.0.0/16
acl private_nets dst fc00::/7
acl private_nets dst fe80::/10

# Cloud metadata services to BLOCK (prevents credential theft)
acl metadata_services dst 169.254.169.254/32

# Allow from Docker internal network
acl docker_network src 172.20.0.0/16

# Security rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny manager

# CRITICAL: Block access to private networks and metadata
http_access deny to_localhost
http_access deny private_nets
http_access deny metadata_services

# Allow Docker containers
http_access allow docker_network

# Deny all other access
http_access deny all

# Proxy settings
http_port 3128

# Cache settings (minimal caching for security)
cache deny all

# Disable cache directory
cache_dir null /tmp

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# DNS settings
dns_nameservers 9.9.9.9 149.112.112.112

# Don't reveal proxy version
httpd_suppress_version_string on

# Performance
maximum_object_size 0 KB
